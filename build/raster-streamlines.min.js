// raster-streamlines Version 0.1.0. Copyright 2020 Roger Veciana i Rovira.
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.rastertools=t.rastertools||{})}(this,function(t){"use strict";function e(t,e){if(t.length<=1||e.length<=1||t[0].length<=1||e[0].length<=1)throw new Error("Raster is too small");if(t.length!==e.length||t[0].length!==e[0].length)throw new Error("Raster components are not the same shape");this.uData=t,this.vData=e,this.xSize=this.uData[0].length,this.ySize=this.uData.length,this.usedPixels=new Array(this.ySize);for(var i=0;i<this.ySize;i++)this.usedPixels[i]=new Array(this.xSize).fill(!1)}function i(t,e,i){return t<=e?e:t>=i?i:t}var s=function(t,i,s,r,a){r=r||1;var n={type:"FeatureCollection",features:[]},o=0,h=new e(t,i);if(s&&6!==s.length)throw new Error("Bad geotransform");const u=Math.round(h.ySize/(60*r))||1;for(var l=h.xSize*h.ySize,f=0;f<l;f++){var y=327685*f%l,p=Math.trunc(y/h.ySize),x=y%h.ySize;if(h.isPixelFree(p,x,u)){var S=h.getLine(p,x,a);S&&(n.features.push({type:"Feature",geometry:{type:"LineString",coordinates:h.applyGeoTransform(S,s)},properties:{num_line:o}}),o++)}}return n};e.prototype.isPixelFree=function(t,e,i){if(t<0||t>=this.xSize||e<0||e>=this.ySize)return!1;const s=Math.max(t-i,0),r=Math.min(t+i,this.xSize-1),a=Math.max(e-i,0),n=Math.min(e+i,this.ySize-1);for(var o=s;o<=r;o++)for(var h=a;h<=n;h++)if(this.usedPixels[h][o])return!1;return!0},e.prototype.getLine=function(t,e,i){var s,r,a,n=!1,o=t,h=e,u=[[o,h]];for(i=i?1:-1;o>=0&&o<this.xSize&&h>=0&&h<this.ySize;){if(a=this.getValueAtPoint(o,h),0===a.u&&0===a.v){this.usedPixels[e][t]=!0;break}if(o+=a.u,h+=i*a.v,r=Math.floor(h),s=Math.floor(o),o<0||h<0||o>=this.xSize||h>=this.ySize||this.usedPixels[r][s])break;u.push([o,h]),n=!0,this.usedPixels[r][s]=!0}for(o=t,h=e;o>=0&&o<this.xSize&&h>=0&&h<this.ySize;){if(a=this.getValueAtPoint(o,h),0===a.u&&0===a.v){this.usedPixels[e][t]=!0;break}if(o-=a.u,h-=i*a.v,r=Math.floor(h),s=Math.floor(o),o<0||h<0||o>=this.xSize||h>=this.ySize||this.usedPixels[r][s])break;u.unshift([o,h]),n=!0,this.usedPixels[r][s]=!0}return!!n&&(this.usedPixels[e][t]=!0,u)},e.prototype.applyGeoTransform=function(t,e){function i(t){return[e[0]+e[1]*t[0]+e[2]*t[1],e[3]+e[4]*t[0]+e[5]*t[1]]}return null==e?t:t.map(i)},e.prototype.getValueAtPoint=function(t,e){const s=i(Math.floor(t),0,this.xSize-2),r=s+1,a=i(Math.floor(e),0,this.ySize-2),n=a+1,o=t-s,h=1-o,u=e-a,l=1-u,f=l*h,y=u*h,p=l*o,x=u*o,S=this.uData[a][s]*f+this.uData[a][r]*y+this.uData[n][s]*p+this.uData[n][r]*x,z=this.vData[a][s]*f+this.vData[a][r]*y+this.vData[n][s]*p+this.vData[n][r]*x,d=Math.max(Math.abs(S),Math.abs(z))||1;return{u:S/d,v:z/d}},t.streamlines=s,Object.defineProperty(t,"__esModule",{value:!0})});